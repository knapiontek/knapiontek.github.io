<!DOCTYPE html>
<html>
<head>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css' integrity='sha384-wE+lCONuEo/QSfLb4AfrSk7HjWJtc4Xc1OiB2/aDBzHzjnlBP4SX7vjErTcwlA8C' crossorigin='anonymous'>
<script src='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js' integrity='sha384-tdtuPw3yx/rnUGmnLNWXtfjb9fpmwexsd+lr6HUYnUY4B7JhB5Ty7a1mYd+kto/s' crossorigin='anonymous'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
<style>
#main_page {
    padding: 2cm;
    width: 19cm;
    margin-left: auto;
    margin-right: auto;
    background-color: #ffffff;
    box-shadow: 10px 10px 5px #888888;
}
body {
    background-color: #cccccc;
    font: 14px Myriad,Helvetica,Tahoma,Arial,clean,sans-serif;
    font-size: 0.8em;
    line-height: 1.5em;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
}
#system {
    width: 80%;
    margin: 0 auto;
    border: thin solid;
}
#segment {
    position: relative
}
#euler {
    position: relative
}
</style>
</head>
<body>
<div id='main_page'>

<h4>Segment Intersection</h4>
<div class='math'>
\begin{matrix}
\hat b = \frac{\vec{b}}{|\vec{b}|} \\
\\
d_1+d_2 = \vec{v_2}\cdot\hat b - \vec{v_1}\cdot\hat b \\
\\
c_1 = \vec{v_1}\times\hat b \\
c_2 = \vec{v_2}\times\hat b \\
\\
\frac{d_1}{c_1} = \frac{d_1+d_2}{c_1+c_2}
\end{matrix}
</div>
<p>Simulation</p>
<div id='segment'></div>
<h4>Euler Equation</h4>
<div class='math'>
e^{-\gamma+i\omega} = e^{-\gamma t}(\cos\omega t+i\sin\omega t)
</div>
<p>Simulation</p>
<div id='euler'></div>

</div>

<script>
function Canvas(element, size) {
    var that = {}

    that.element = $(element)
    that.size = size
    that.canvas = $('<canvas>')

    var canvas = that.canvas.get(0);
    canvas.id = 'system';
    canvas.width = size
    canvas.height = size
    that.element.append(canvas)

    that.context = canvas.getContext('2d')
    that.context.clearRect(0, 0, size, size)
    that.context.beginPath()

    that.move_to = function(pt) {
        that.context.moveTo(pt.x, pt.y)
    }

    that.line_to = function(pt) {
        that.context.lineTo(pt.x, pt.y)
    }

    that.stroke = function(pt) {
        that.context.stroke()
    }

    that.pike = function(begin, end, style) {
        that.style(style)

        var line = {x: end.x - begin.x, y: end.y - begin.y}
        var len = Math.sqrt((line.x * line.x) + (line.y * line.y))
        var unit = {x: line.x / len, y: line.y / len}

        var v = 15
        var h = 4
        var left = {
            x: end.x - (v * unit.x) + (h * unit.y),
            y: end.y - (v * unit.y) - (h * unit.x)
        }
        var right = {
            x: end.x - (v * unit.x) - (h * unit.y),
            y: end.y - (v * unit.y) + (h * unit.x)
        }

        that.context.moveTo(end.x, end.y)
        that.context.lineTo(left.x, left.y)
        that.context.lineTo(right.x, right.y)
        that.context.fill()
    }

    that.line = function(begin, end, style) {
        that.style(style)

        that.context.moveTo(begin.x, begin.y)
        that.context.lineTo(end.x, end.y)
        that.context.stroke()
    }

    that.pike_line = function(begin, end, style) {
        that.pike(begin, end, style)

        that.context.moveTo(begin.x, begin.y)
        that.context.lineTo(end.x, end.y)
        that.context.stroke()
    }

    that.dot = function(pt, style) {
        that.style(style)

        that.context.beginPath()
        that.context.arc(pt.x, pt.y, 5, 0, 2*Math.PI)
        that.context.fill()
    }

    that.text = function(text, pt) {
        var x = pt.x * that.canvas.width() / that.size
        var y = pt.y * that.canvas.height() / that.size

        var div = $('<div>').get(0);
        div.style.position = 'absolute';
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.style.z_index = '1'
        katex.render(text, div, {displayMode: false})
        that.element.append(div)
    }

    that.style = function(style) {
        if(style) {
            if(style.width) {
                that.context.lineWidth = style.width
            }
            if(style.dash) {
                that.context.setLineDash(style.dash)
            }
        } else {
            return {
                width: that.context.lineWidth,
                dash: that.context.getLineDash()
            }
        }
    }

    return that
}

function Point2D(x, y) {
    var that = {x: x, y: y}

    that.add = function(pt) {
        return Point2D(that.x + pt.x, that.y + pt.y)
    }

    that.sub = function(pt) {
        return Point2D(that.x - pt.x, that.y - pt.y)
    }

    that.mul = function(no) {
        return Point2D(that.x * no, that.y * no)
    }

    that.div = function(no) {
        return Point2D(that.x / no, that.y / no)
    }

    that.norm2 = function() {
        return that.x * that.x + that.y * that.y
    }

    that.norm = function() {
        return Math.sqrt(that.norm2())
    }

    that.unit = function() {
        return that.div(that.norm())
    }

    that.dot = function(pt) {
        return that.x * pt.x + that.y * pt.y
    }

    that.rot = function(pt) {
        return that.x * pt.y - that.y * pt.x
    }

    return that
}

function Vector(arg) {
    var that = {}

    if($.isNumeric(arg)) {
        var size = arg
        that.data = []
        for(var i = 0; i < size; i++) {
            that.data[i] = 0.0
        }
    } else if($.isArray(arg)) {
        that.data = arg
    } else {
        console.assert(false)
    }

    that.add = function(vec) {
        console.assert(that.data.length == vec.data.length)
        for(var i = 0; i < that.data.length; i++) {
            that.data[i] += vec[i]
        }
        return that
    }

    that.sub = function(vec) {
        console.assert(that.data.length == vec.data.length)
        for(var i = 0; i < that.data.length; i++) {
            that.data[i] -= vec[i]
        }
        return that
    }

    that.mul = function(no) {
        for(var i = 0; i < that.data.length; i++) {
            that.data[i] *= no
        }
        return that
    }

    that.div = function(no) {
        for(var i = 0; i < that.data.length; i++) {
            that.data[i] /= no
        }
        return that
    }

    that.norm2 = function(vec) {
        console.assert(that.data.length == vec.data.length)
        var acc = 0.0
        for(var i = 0; i < that.data.length; i++) {
            acc += that.data[i]*vec.data[i] - that.data[i]*vec.data[i]
        }
        return acc
    }

    return that
}

function Matrix(arg, value) {
    var that = {}

    if($.isNumeric(arg)) {
        var size = arg
        that.data = []
        for(var i1 = 0; i1 < size; i1++) {
            that.data[i1] = []
            for(var i2 = 0; i2 < size; i2++) {
                that.data[i1][i2] = 0.0
            }
        }
        
        if(value) {
            for(var i = 0; i < size; i++) {
                that.data[i][i] = value
            }
        }
    } else if($.isArray(arg)) {
        that.data = arg
    } else {
        console.assert(false)
    }

    that.mul = function(vec) {
        console.assert(that.data.length == vec.data.length)
        var out = Vector([])
        for(var i1 = 0; i1 < that.data.length; i1++) {
            var acc = 0.0
            for(var i2 = 0; i2 < vec.data.length; i2++)
                acc += that.data[i1][i2] * vec.data[i2]
            out.data[i1] = acc
        }
        return out
    }

    that.lu = function(vb) {
        // A * X = B
        console.assert(that.data.length == b.data.length)

        var size = b.data.length
        var vx = Vector(size)
        var ml = Matrix(size, 1) // lower matrix
        var mu = Matrix(size) // upper matrix
        var vz = Vector(size) // auxiliary vector

        // find L, U where L * U = A
        for(var i1 = 0; i1 < size; i1++) {
            var acc = 0.0
            for(var i2 = 0; i2 < size; i2++)
                acc += ml.data[i1][i2] * mu.data[i2][i1]
            mu.data[i1][i1] = that.data[i1][i1] - acc

            for(var i2 = i1 + 1; i2 < size; i2++) {
                acc = 0.0
                for(var i3 = 0; i3 < i1; i3++)
                    acc += ml.data[i1][i3] * mu.data[i3][i2]
                mu.data[i1][i2] = that.data[i1][i2] - acc

                acc = 0.0
                for(var i3 = 0; i3 < i1; i3++)
                    acc += ml.data[i2][i3] * mu.data[i3][i1]
                ml.data[i2][i1] = (that.data[i2][i1] - acc) / mu.data[i1][i1]
            }
        }

        // finally find result
        for(var i1 = 0; i1 < size; i1++) {
            // find Z where L * Z = B
            var acc = 0.0
            for(var i2 = 0; i2 < i1; i2++)
                acc += ml.data[i1][i2] * vz.data[i2]
            vz.data[i1] = b.data[i1] - acc
        }
        for(var i1 = size - 1; i1 >= 0; i1--) {
            // find X where U * X = Z
            var acc = 0.0
            for(var i2 = i1; i2 < size; i2++)
                acc += mu.data[i1][i2] * vx.data[i2]
            vx.data[i1] = (vz.data[i1] - acc) / mu.data[i1][i1]
        }
        
        return x
    }
    
    return that
}

function test_lu() {
    var ma = Matrix([[1, 2], [3, 4]])
    var vb = Vector([5, 11])
    var vx = ma.lu(vb)

    var expected = ma.mul(vx)
    console.assert(expected.norm2(vb) < 0.001)
}

function render_katex() {
    $('.math').each(function() {
        var tex = $(this).text()
        elem = $(this).get(0)
        try {
            katex.render(tex, elem, {displayMode: true})
        }
        catch(err) {
            $(this).html('<span class="error">' + err)
        }
    })
    $('.inmath').each(function() {
        var tex = $(this).text()
        elem = $(this).get(0)
        try {
            katex.render(tex, elem, {displayMode: false})
        }
        catch(err) {
            $(this).html('<span class="error">' + err)
        }
    })
}

function run_segment() {
    var size = 700
    var canvas = Canvas('#segment', size)

    var a1 = Point2D(50, 150)
    var a2 = Point2D(650, 400)
    var b1 = Point2D(100, 650)
    var b2 = Point2D(650, 50)

    var ub = b2.sub(b1).unit()

    var v1 = a1.sub(b1)
    var v2 = a2.sub(b1)

    var d1 = v1.dot(ub)
    var d2 = v2.dot(ub)

    var c1 = ub.rot(v1)
    var c2 = v2.rot(ub)

    var pd1 = b1.add(ub.mul(d1))
    var pd2 = b1.add(ub.mul(d2))

    var po = pd1.add(ub.mul(c1*(d2-d1)/(c1+c2)))

    var default_style = canvas.style()
    var dash_style = {width:1, dash:[12, 7]}

    canvas.line(a1, a2)
    canvas.pike_line(b1, b2)

    canvas.pike(b1, pd1)
    canvas.pike(b1, pd2)

    canvas.line(a1, pd1, dash_style)
    canvas.line(a2, pd2)

    canvas.pike_line(b1, a1)
    canvas.pike_line(b1, a2)

    canvas.dot(po)

    canvas.text('O', po.add(Point2D(0, 15)))
    canvas.text('c_1', a1.add(pd1).div(2).add(Point2D(20, -10)))
    canvas.text('c_2', a2.add(pd2).div(2).add(Point2D(10, -20)))
    canvas.text('d_1', pd1.add(po).div(2).add(Point2D(5, 5)))
    canvas.text('d_2', pd2.add(po).div(2).add(Point2D(5, 5)))

    canvas.text('\\vec{b}', b2.add(Point2D(-30, 0)))
    canvas.text('\\vec{v_1}', v1.div(-2).add(a1).add(Point2D(10, 0)))
    canvas.text('\\vec{v_2}', v2.div(2).add(b1).add(Point2D(0, 10)))
    canvas.text('\\vec{v_1}\\cdot\\hat b', b1.add(pd1).div(2).add(Point2D(-20, -40)))
}

function euler(t) {
    var damp = Math.pow(Math.E, -t/45)
    return Point2D(Math.cos(t), Math.sin(t)).mul(damp)
}

function run_euler() {
    var size = 700
    var canvas = Canvas('#euler', size)
    
    canvas.line(Point2D(0, 0), Point2D(size, size))
    
    var max = 200
    var middle = Point2D(size, size).div(2)
    canvas.move_to(euler(0).mul(max).add(middle))
    for(var i = 0.01; i < 20; i+=0.01) {
        canvas.line_to(euler(i).mul(max).add(middle))
    }
    canvas.stroke()
}

run_segment()
run_euler()
render_katex()
test_lu()
</script>

</body>
</html>
