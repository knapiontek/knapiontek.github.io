<!DOCTYPE html>
<html>
<head>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css' integrity='sha384-wE+lCONuEo/QSfLb4AfrSk7HjWJtc4Xc1OiB2/aDBzHzjnlBP4SX7vjErTcwlA8C' crossorigin='anonymous'>
<script src='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js' integrity='sha384-tdtuPw3yx/rnUGmnLNWXtfjb9fpmwexsd+lr6HUYnUY4B7JhB5Ty7a1mYd+kto/s' crossorigin='anonymous'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
<style>
#main_page {
    padding: 2cm;
    width: 19cm;
    margin-left: auto;
    margin-right: auto;
    background-color: #ffffff;
    box-shadow: 10px 10px 5px #888888;
}
body {
    background-color: #cccccc;
    font: 14px Myriad,Helvetica,Tahoma,Arial,clean,sans-serif;
    font-size: 0.8em;
    line-height: 1.5em;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
}
#system2 {
    width: 100%;
    margin: 0 auto;
    border: thin solid;
}
#system3 {
    width: 100%;
    margin: 0 auto;
    border: thin solid;
}
</style>
</head>
<body>
<div id='main_page'>

<p>Consider 3 square polynomial equations</p>
<div class='math'>
\begin{cases}
x_0(t) = a_0t^2 + b_0t + c_0 \\
x'_0(t) = 2a_0t + b_0
\end{cases}
\begin{cases}
x_1(t) = a_1t^2 + b_1t + c_1 \\
x'_1(t) = 2a_1t + b_1
\end{cases}
\begin{cases}
x_2(t) = a_2t^2 + b_2t + c_2 \\
x'_2(t) = 2a_2t + b_2
\end{cases}
</div>

<p>Let's evaluated them in points <b class='inmath'>t=0, t=1</b></p>
<div class='math'>
\begin{cases}
x_0(0) = c_0 \\
x'_0(0) = b_0 \\
x_0(1) = a_0 + b_0 + c_0 \\
x'_0(1) = 2a_0 + b_0
\end{cases}
\begin{cases}
x_1(0) = c_1 \\
x'_1(0) = b_1 \\
x_1(1) = a_1 + b_1 + c_1 \\
x'_1(1) = 2a_1 + b_1
\end{cases}
\begin{cases}
x_2(0) = c_2 \\
x'_2(0) = b_2 \\
x_2(1) = a_2 + b_2 + c_2 \\
x'_2(1) = 2a_2 + b_2
\end{cases}
</div>

<p>We add extra constraints to ensure continuity in the point of joining</p>
<div class='math'>
\begin{cases}
x'_0(1) = x'_1(0) \\
x'_1(1) = x'_2(0) \\
x'_2(1) = x'_0(0)
\end{cases}
</div>

<p>We can expand it for 3 fixed points <b class='inmath'>x_0, x_1, x_2</b></p>
<div class='math'>
\begin{cases}
2a_0 + b_0 = b_1 \\
x_1 = a_0 + b_0 + c_0 \\
x_0 = c_0 \\
2a_1 + b_1 = b_2 \\
x_2 = a_1 + b_1 + c_1 \\
x_1 = c_1 \\
2a_2 + b_2 = b_0 \\
x_0 = a_2 + b_2 + c_2 \\
x_2 = c_2
\end{cases}
</div>

<p>In the matrix notation</p>
<div class='math'>
\begin{bmatrix}
2 & 1 & 0 & 0 & -1 & 0 & 0 & 0 & 0 \\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 2 & 1 & 0 & 0 & -1 & 0 \\
0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
0 & -1 & 0 & 0 & 0 & 0 & 2 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
a_0 \\ b_0 \\ c_0 \\ a_1 \\ b_1 \\ c_1 \\ a_2 \\ b_2 \\ c_2
\end{bmatrix}
=
\begin{bmatrix}
0 \\ x_1 \\ x_0 \\ 0 \\ x_2 \\ x_1 \\ 0 \\ x_0 \\ x_2
\end{bmatrix}
</div>

<p>Finally the result</p>
<div><canvas id='system2'></div>

<p>Consider 3 cubic polynomial equations</p>
<div class='math'>
\begin{cases}
x_0(t) = a_0t^3 + b_0t^2 + c_0t + d_0 \\
x'_0(t) = 3a_0t^2 + 2b_0t + c_0 \\
x''_0(t) = 6a_0t + 2b_0
\end{cases}
\begin{cases}
x_1(t) = a_1t^3 + b_1t^2 + c_1t + d_1 \\
x'_1(t) = 3a_1t^2 + 2b_1t + c_1 \\
x''_1(t) = 6a_1t + 2b_1
\end{cases}
\begin{cases}
x_2(t) = a_2t^3 + b_2t^2 + c_2t + d_2 \\
x'_2(t) = 3a_2t^2 + 2b_2t + c_2 \\
x''_2(t) = 6a_2t + 2b_2
\end{cases}
</div>

<p>Let's evaluated them in points <b class='inmath'>t=0, t=1</b></p>
<div class='math'>
\begin{cases}
x_0(0) = d_0 \\
x'_0(0) = c_0 \\
x''_0(0) = 2b_0 \\
x_0(1) = a_0 + b_0 + c_0 + d_0 \\
x'_0(1) = 3a_0 + 2b_0 + c_0 \\
x''_0(1) = 6a_0 + 2b_0
\end{cases}
\begin{cases}
x_1(0) = d_1 \\
x'_1(0) = c_1 \\
x''_1(0) = 2b_1 \\
x_1(1) = a_1 + b_1 + c_1 + d_1 \\
x'_1(1) = 3a_1 + 2b_1 + c_1 \\
x''_1(1) = 6a_1 + 2b_1
\end{cases}
\begin{cases}
x_2(0) = d_2 \\
x'_2(0) = c_2 \\
x''_2(0) = 2b_2 \\
x_2(1) = a_2 + b_2 + c_2 + d_2 \\
x'_2(1) = 3a_2 + 2b_2 + c_2 \\
x''_2(1) = 6a_2 + 2b_2
\end{cases}
</div>

<p>We add extra constraints to ensure continuity in the point of joining</p>
<div class='math'>
\begin{cases}
x'_0(1) = x'_1(0) \\
x''_0(1) = x''_1(0) \\
x'_1(1) = x'_2(0) \\
x''_1(1) = x''_2(0) \\
x'_2(1) = x'_0(0) \\
x''_2(1) = x''_0(0)
\end{cases}
</div>

<p>We can expand it for 3 fixed points <b class='inmath'>x_0, x_1, x_2</b></p>
<div class='math'>
\begin{cases}
2a_0 + b_0 = b_1 \\
x_1 = a_0 + b_0 + c_0 \\
x_0 = c_0 \\
2a_1 + b_1 = b_2 \\
x_2 = a_1 + b_1 + c_1 \\
x_1 = c_1 \\
2a_2 + b_2 = b_0 \\
x_0 = a_2 + b_2 + c_2 \\
x_2 = c_2
\end{cases}
</div>

<p>In the matrix notation</p>
<div class='math'>
\begin{bmatrix}
2 & 1 & 0 & 0 & -1 & 0 & 0 & 0 & 0 \\
1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 2 & 1 & 0 & 0 & -1 & 0 \\
0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
0 & -1 & 0 & 0 & 0 & 0 & 2 & 1 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
a_0 \\ b_0 \\ c_0 \\ a_1 \\ b_1 \\ c_1 \\ a_2 \\ b_2 \\ c_2
\end{bmatrix}
=
\begin{bmatrix}
0 \\ x_1 \\ x_0 \\ 0 \\ x_2 \\ x_1 \\ 0 \\ x_0 \\ x_2
\end{bmatrix}
</div>

<p>Finally the result</p>
<div><canvas id='system3'></div>

<script>
function arrow(context, begin, end) {
    line = {x: end.x - begin.x, y: end.y - begin.y}
    len = Math.sqrt((line.x * line.x) + (line.y * line.y))
    unit = {x: line.x / len, y: line.y / len}

    v = 25
    h = 8
    left = {
        x: end.x - (v * unit.x) + (h * unit.y),
        y: end.y - (v * unit.y) - (h * unit.x)
    }
    right = {
        x: end.x - (v * unit.x) - (h * unit.y),
        y: end.y - (v * unit.y) + (h * unit.x)
    }

    context.moveTo(begin.x, begin.y)
    context.lineTo(end.x, end.y)
    context.stroke()

    context.moveTo(end.x, end.y)
    context.lineTo(left.x, left.y)
    context.lineTo(right.x, right.y)
    context.fill()
}
function point(x, y) {
        return {x: x, y: y}
}
function vector_zero(size)
{
    vector = []
    for(var i = 0; i < size; i++)
    {
        vector[i] = 0.0
    }
    return vector
}
function vector_norm2(vec1, vec2)
{
    console.assert(vec1.length == vec2.length)

    var acc = 0.0
    for(var i = 0; i < vec1.length; i++)
    {
        acc += vec1[i] * vec2[i]
    }
    return acc
}
function square_matrix_zero(size)
{
    matrix = []
    for(var i1 = 0; i1 < size; i1++)
    {
        matrix[i1] = []
        for(var i2 = 0; i2 < size; i2++)
        {
            matrix[i1][i2] = 0.0
        }
    }
    return matrix
}
function square_matrix_identity(size)
{
    matrix = []
    for(var i1 = 0; i1 < size; i1++)
    {
        matrix[i1] = []
        for(var i2 = 0; i2 < size; i2++)
        {
            matrix[i1][i2] = Number(i1 == i2)
        }
    }
    return matrix
}
function square_matrix_mul(matrix, in_vec)
{
    console.assert(matrix[0].length == in_vec.length)

    out_vec = []
    for(var i1 = 0; i1 < matrix.length; i1++)
    {
        var acc = 0.0
        for(var i2 = 0; i2 < in_vec.length; i2++)
            acc += matrix[i1][i2] * in_vec[i2]
        out_vec[i1] = acc
    }
    return out_vec
}
function calculate_equation_system(A, B) // solving A * X = B by LU method
{
    console.assert(A.length == B.length)

    var size = B.length
    var X = vector_zero(size)
    var L = square_matrix_identity(size) // lower matrix
    var U = square_matrix_zero(size) // upper matrix
    var Z = vector_zero(size) // auxiliary vector

    // find L, U where L * U = A
    for(var i1 = 0; i1 < size; i1++)
    {
        var acc = 0.0
        for(var i2 = 0; i2 < size; i2++)
            acc += L[i1][i2] * U[i2][i1]
        U[i1][i1] = A[i1][i1] - acc

        for(var i2 = i1 + 1; i2 < size; i2++)
        {
            acc = 0.0
            for(var i3 = 0; i3 < i1; i3++)
                acc += L[i1][i3] * U[i3][i2]
            U[i1][i2] = A[i1][i2] - acc

            acc = 0.0
            for(var i3 = 0; i3 < i1; i3++)
                acc += L[i2][i3] * U[i3][i1]
            L[i2][i1] = (A[i2][i1] - acc) / U[i1][i1]
        }
    }

    // finally find result
    for(var i1 = 0; i1 < size; i1++)
    {
        // find Z where L * Z = B
        var acc = 0.0
        for(var i2 = 0; i2 < i1; i2++)
            acc += L[i1][i2] * Z[i2]
        Z[i1] = B[i1] - acc
    }
    for(var i1 = size - 1; i1 >= 0; i1--)
    {
        // find X where U * X = Z
        var acc = 0.0
        for(var i2 = i1; i2 < size; i2++)
            acc += U[i1][i2] * X[i2]
        X[i1] = (Z[i1] - acc) / U[i1][i1]
    }
    
    // return
    return X
}
function test_calculate_equation_system() {
    var size = 2
    var A = [[1, 2], [3, 4]]
    var B = [5, 11]
    var X = calculate_equation_system(A, B)

    var E = square_matrix_mul(A, X)
    console.assert(vector_norm2(E, B))
}
function generate_matrix2(data) {
    var size = 3 * data.length
    var A = square_matrix_zero(size)
    var Bx = vector_zero(size)
    var By = vector_zero(size)

    for(var i = 0; i < data.length; i++) {
        var j = 3 * i

        A[j+0][j+0] = 2.0
        A[j+0][j+1] = 1.0
        A[j+0][(j+4)%size] = -1.0
        A[j+1][j+0] = 1.0
        A[j+1][j+1] = 1.0
        A[j+1][j+2] = 1.0
        A[j+2][j+2] = 1.0

        Bx[j+2] = data[i].x
        Bx[(j-2+size)%size] = data[i].x

        By[j+2] = data[i].y
        By[(j-2+size)%size] = data[i].y
    }

    return [A, Bx, By]
}
function render_spline2() {
    var data = [point(300, 300),
            point(200, 200),
            point(400, 450),
            point(600, 800),
            point(600, 600)]

    var size = 1000
    var system = $('#system2').get(0)
    var context = system.getContext('2d')
    system.width = size
    system.height = size
    context.clearRect(0, 0, size, size)
    context.fillStyle = 'blue'

    for(var i = 0; i < data.length; i++) {
        context.beginPath()
        context.arc(data[i].x, data[i].y, 4, 0, 2 * Math.PI, true);
        context.fill()
    }

    var [A, Bx, By] = generate_matrix2(data)
    var Ux = calculate_equation_system(A, Bx)
    var Uy = calculate_equation_system(A, By)

    var Ex = square_matrix_mul(A, Ux)
    var Ey = square_matrix_mul(A, Uy)
    console.assert(vector_norm2(Ex, Bx))
    console.assert(vector_norm2(Ey, By))
    
    context.beginPath()
    context.moveTo(cx, cy)
    for(var i = 0; i < data.length; i++) {
        var j = 3 * i
        var ax = Ux[j+0]
        var bx = Ux[j+1]
        var cx = Ux[j+2]
        var ay = Uy[j+0]
        var by = Uy[j+1]
        var cy = Uy[j+2]
        for(var t = 0; t < 1; t += 0.05) {
            var x = (ax*t*t) + (bx*t) + cx
            var y = (ay*t*t) + (by*t) + cy
            context.lineTo(x, y)
        }
        context.lineTo(data[(i+1)%data.length].x, data[(i+1)%data.length].y)
    }
    context.stroke()
}
function generate_matrix3(data) {
    var size = 3 * data.length
    var A = square_matrix_zero(size)
    var Bx = vector_zero(size)
    var By = vector_zero(size)

    for(var i = 0; i < data.length; i++) {
        var j = 3 * i

        A[j+0][j+0] = 2.0
        A[j+0][j+1] = 1.0
        A[j+0][(j+4)%size] = -1.0
        A[j+1][j+0] = 1.0
        A[j+1][j+1] = 1.0
        A[j+1][j+2] = 1.0
        A[j+2][j+2] = 1.0

        Bx[j+2] = data[i].x
        Bx[(j-2+size)%size] = data[i].x

        By[j+2] = data[i].y
        By[(j-2+size)%size] = data[i].y
    }

    return [A, Bx, By]
}
function render_spline3() {
    var data = [point(300, 300),
            point(200, 200),
            point(400, 450),
            point(600, 800),
            point(600, 600)]

    var size = 1000
    var system = $('#system3').get(0)
    var context = system.getContext('2d')
    system.width = size
    system.height = size
    context.clearRect(0, 0, size, size)
    context.fillStyle = 'blue'

    for(var i = 0; i < data.length; i++) {
        context.beginPath()
        context.arc(data[i].x, data[i].y, 4, 0, 2 * Math.PI, true);
        context.fill()
    }

    var [A, Bx, By] = generate_matrix3(data)
    var Ux = calculate_equation_system(A, Bx)
    var Uy = calculate_equation_system(A, By)

    var Ex = square_matrix_mul(A, Ux)
    var Ey = square_matrix_mul(A, Uy)
    console.assert(vector_norm2(Ex, Bx))
    console.assert(vector_norm2(Ey, By))
    
    context.beginPath()
    context.moveTo(cx, cy)
    for(var i = 0; i < data.length; i++) {
        var j = 3 * i
        var ax = Ux[j+0]
        var bx = Ux[j+1]
        var cx = Ux[j+2]
        var ay = Uy[j+0]
        var by = Uy[j+1]
        var cy = Uy[j+2]
        for(var t = 0; t < 1; t += 0.05) {
            var x = (ax*t*t) + (bx*t) + cx
            var y = (ay*t*t) + (by*t) + cy
            context.lineTo(x, y)
        }
        context.lineTo(data[(i+1)%data.length].x, data[(i+1)%data.length].y)
    }
    context.stroke()
}
function render_katex() {
    $('.math').each(function() {
        var texTxt = $(this).text()
        elem = $(this).get(0)
        try {
            katex.render(texTxt, elem, { displayMode: true })
        }
        catch(err) {
            $(this).html('<span class="error">' + err)
        }
    })
    $('.inmath').each(function() {
        var texTxt = $(this).text()
        elem = $(this).get(0)
        try {
            katex.render(texTxt, elem, { displayMode: false })
        }
        catch(err) {
            $(this).html('<span class="error">' + err)
        }
    })
}
test_calculate_equation_system()
render_spline2()
render_spline3()
render_katex()
</script>
</body>
</html>
